From: Antoine Musso <hashar@free.fr>
Date: Mon, 18 Jul 2016 12:11:13 +0200
Subject: Gerrit trailing delay is now configurable

Zuul handling of events is always behind Gerrit by 10 seconds due to
change dependencies tracking being off immediately after a patchset has
been uploaded.

Make it a configuration option to easily fine tune the delay. On some
third parties setup the delay can be significantly reduced.

GerritEventConnector() delay moved to a class parameter, default to 10.

GerritConnection() now recognizes the optional configuration setting
'event_delay' in zuul.conf representing the amount of seconds to delay.
Default to 10 as well.

Change the way test/base.py set the GerritEventConnector delay by
injecting the 'event_delay' setting when the test suite load the
configuration.

Fix an unrelated typo in GerritConnection debug log.

Update documentation inspired by James E. Blair code comment and commit
message summaries that introduced the delay:

    5241b88 Delay Gerrit events by 5s
    490f4aa Increase the Gerrit trailing delay

Change-Id: I0179d5bac6e0b3313e44e850823385345d28cb9d
---
 tests/base.py              |  2 +-
 4 files changed, 22 insertions(+), 5 deletions(-)

diff --git a/tests/base.py b/tests/base.py
index 9dc412b..f9dd729 100755
--- a/tests/base.py
+++ b/tests/base.py
@@ -1026,7 +1026,6 @@ class ZuulTestCase(BaseTestCase):
 
         zuul.source.gerrit.GerritSource.replication_timeout = 1.5
         zuul.source.gerrit.GerritSource.replication_retry_interval = 0.5
-        zuul.connection.gerrit.GerritEventConnector.delay = 0.0
 
         self.sched = zuul.scheduler.Scheduler(self.config)
 
@@ -1120,6 +1119,7 @@ class ZuulTestCase(BaseTestCase):
                         Queue.Queue()
                     self.event_queues.append(
                         self.gerrit_queues_dbs[con_config['server']])
+                con_config['event_delay'] = 0.0
                 self.connections[con_name] = FakeGerritConnection(
                     con_name, con_config,
                     changes_db=self.gerrit_changes_dbs[con_config['server']],
