From: Antoine Musso <hashar@free.fr>
Date: Fri, 16 Feb 2018 19:17:13 +0100
Subject: wmf: debug log for GerritSource._updateChange

Bug: T187567
Change-Id: I1e9c4c6f8530518eb59ec1bb22689b70b7b301b9
---
 zuul/source/gerrit.py | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/zuul/source/gerrit.py b/zuul/source/gerrit.py
index e7284fe..7ebdce6 100644
--- a/zuul/source/gerrit.py
+++ b/zuul/source/gerrit.py
@@ -235,11 +235,14 @@ class GerritSource(BaseSource):
 
     def _updateChange(self, change, history=None):
         self.log.info("Updating %s" % (change,))
+        self.log.debug("T187567 %s pre change: %s" % (change, vars(change)))
         data = self.connection.query(change.number)
         change._data = data
 
         if change.patchset is None:
             change.patchset = data['currentPatchSet']['number']
+            self.log.debug("T187567 %s change.patchset = %s %s" % (
+                change, type(change.patchset), change.patchset))
 
         if 'project' not in data:
             raise exceptions.ChangeNotFound(change.number, change.patchset)
@@ -249,11 +252,18 @@ class GerritSource(BaseSource):
         max_ps = 0
         files = []
         for ps in data['patchSets']:
+            self.log.debug("T187567 %s checking Gerrit ps %s %s == %s %s" % (
+                change,
+                type(ps['number']), ps['number'],
+                type(change.patchset), change.patchset))
             # In some cases change.patchset is a string and in some cases the
             # connection query can return an int. Cast both patchsets to
             # strings to compare value not type.
             if str(ps['number']) == str(change.patchset):
                 change.refspec = ps['ref']
+                self.log.debug(
+                    "T187567 %s found matching patchset: "
+                    "change.refspec = %s" % (change, change.refspec))
                 for f in ps.get('files', []):
                     files.append(f['file'])
             if int(ps['number']) > int(max_ps):
@@ -347,6 +357,9 @@ class GerritSource(BaseSource):
                 needed_by_changes.append(dep)
         change.needed_by_changes = needed_by_changes
 
+        self.log.debug(
+            "T187567 %s post change: patchset = %s, refspec = %s" % (
+                change, change.patchset, change.refspec))
         return change
 
     def getGitUrl(self, project):
